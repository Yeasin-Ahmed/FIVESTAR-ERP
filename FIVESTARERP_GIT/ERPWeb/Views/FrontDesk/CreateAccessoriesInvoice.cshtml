
@{
    ViewBag.Title = "Invoice Accessories Sells";
}

<div class="row">
    <div class="col-md-12 text-center">
        <div class="card card-gray shadow">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-4 text-left">
                        <a href="/FrontDesk/GetJobOrders" class="btn btn-sm btn-outline-primary" title="Back To List"><i class="fas fa-arrow-alt-circle-left"></i></a>
                    </div>
                    <div class="col-md-4">
                        <h4 class="text-center">Inovoice For Accessories Sells</h4>
                    </div>
                    <div class="col-md-4">
                        <a href="/FrontDesk/GetJobOrders" class="btn btn-outline-danger btn-sm float-lg-right" id="btnReset" title="RESET UI"><i class="fas fa-sync-alt"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row text-sm">
    <div class="col-md-8">
        <div class="card card-secondary shadow">
            <form id="salesAccessories">
                @Html.AntiForgeryToken()
                <div class="card-body shadow">
                    <div class="row" style="border-bottom:1px solid #cecece">
                        <div class="col-md-3">
                            <div class="input-group input-group-sm mb-3">
                                <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptSellsDate" placeholder="Sales Date" />
                                <div class="input-group-prepend cursor-pointer remove-date dptSellsDate" style="cursor:pointer">
                                    <span class="input-group-text">&#10008;</span>
                                </div>
                            </div>
                            <span class="error hide require-dptSellsDate font-weight-bold">Sales date No is required !</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="txtCustomer" class="control-label font-weight-bold">Customer Name</label>
                            <input type="text" class="form-control form-control-sm" id="txtCustomer" />
                            <span class="error hide require-customer font-weight-bold">Name is required !</span>
                        </div>
                        <div class="col-md-3">
                            <label for="txtMobileNumber" class="control-label font-weight-bold">Mobile Number</label>
                            <input type="text" class="form-control form-control-sm" id="txtMobileNumber" />
                            <span class="error hide require-mobile font-weight-bold">Mobile No is required !</span>
                        </div>
                        <div class="col-md-3">
                            <label for="txtEmail" class="control-label font-weight-bold">Email</label>
                            <input type="email" class="form-control form-control-sm" id="txtEmail" />
                        </div>
                        <div class="col-md-3">
                            <label for="txtAddress" class="control-label font-weight-bold">Address</label>
                            <textarea id="txtAddress" class="form-control form-control-sm" cols="10" rows="1"></textarea>
                            <span class="error hide require-address font-weight-bold">Mobile No is required !</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="ddlMobileParts" class="control-label font-weight-bold">Parts Name</label>
                            @Html.DropDownList("ddlMobileParts", (IEnumerable<SelectListItem>)ViewBag.ddlMobileParts, "--Select Parts--", new { @class = "form-control form-control-sm" })
                            <span class="error hide require-mobileParts font-weight-bold">Price is required !</span>
                        </div>
                        <div class="col-md-3">
                            <label for="ddlsellsPrice" class="control-label font-weight-bold">Sells Price</label>
                            @Html.DropDownList("ddlsellsPrice", (IEnumerable<SelectListItem>)ViewBag.ddlsellsPrice,"Select", new { @class = "form-control form-control-sm" })
                            <span class="error hide require-sellPrice font-weight-bold">Price is required !</span>
                        </div>
                        <div class="col-md-3">
                            <label for="txtQty" class="control-label font-weight-bold">Qty<span id="stockQty" class="font-weight-bold mt-2 stockQty" style="color:red"></span></label>
                            <div class="input-group">
                                <div class="col-sm-8">
                                    <input type="number" placeholder="Qty" name="quantity" id="txtQty" class="form-control form-control-sm" />
                                </div>
                                <span id="unitName" class="font-weight-bold mt-3" style="color:darkblue"> </span>
                            </div>
                            <span class="error hide required-qty font-weight-bold">Qty. is required !</span>
                        </div>
                        <div class="col-md-3">
                            <label for="" class="control-label font-weight-bold" style="visibility:hidden"> Add To List</label>
                            <div class="clearfix">
                                <button type="submit" class="btn btn-sm btn-outline-primary float-left mr-1" id="btnAddToList" title="Save"><i class="fas fa-plus"></i> &nbsp; ADD TO LIST</button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <table class="table table-bordered table-sm table-striped table-responsive-lg" id="tblAccessorieSells">
                                                <thead>
                                                    <tr class="btn-dark text-center">
                                                        <th>#SL</th>
                                                        <th class="hide"></th>
                                                        <th>Parts Name</th>
                                                        <th>SellPrice</th>
                                                        <th>Qty.</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-secondary shadow">
            <form>
                <div class="card-body shadow">
                    <div class="row">
                        <div class="col-md-6 hide">
                            <label for="txtWarrenty" class="control-label font-weight-bold">Warrenty For(Month)</label>
                            @*<input type="number" class="form-control form-control-sm" id="txtWarrenty" />*@
                            <select class="form-control form-control-sm" id="txtWarrenty">
                                <option value="3">3</option>
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="18">18</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="txtVAT" class="control-label font-weight-bold">VAT</label>
                            <input type="number" class="form-control form-control-sm" id="txtVAT" />
                            <span class="error hide require-VAT font-weight-bold">Customer name is required !</span>
                        </div>
                        <div class="col-md-6">
                            <label for="txtTAX" class="control-label font-weight-bold">TAX</label>
                            <input type="number" class="form-control form-control-sm" id="txtTAX" />
                            <span class="error hide require-TAX font-weight-bold">Mobile No is required !</span>
                        </div>
                    </div>
                    <div class="row">
                        
                        <div class="col-md-6">
                            <label for="txtDiscount" class="control-label font-weight-bold">Discount</label>
                            <input type="number" class="form-control form-control-sm" id="txtDiscount" />
                            <span class="error hide require-discount font-weight-bold">Customer name is required !</span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="txtDiscount" class="control-label font-weight-bold" style="visibility:hidden">Discount</label>
                            <button type="submit" id="btnInvoiceSubmit" class="btn btn-sm btn-success float-right" title="Submit the form for save"><i class="fas fa-paper-plane"></i> Save </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
@section scripts{
    <script>
        var dptSellsDate = $("#dptSellsDate");
        var txtCustomer = $("#txtCustomer");
        var txtMobileNumber = $("#txtMobileNumber");
        var txtEmail = $("#txtEmail");
        var txtAddress = $("#txtAddress");
        var ddlMobileParts = $("#ddlMobileParts");
        var ddlsellsPrice = $("#ddlsellsPrice");
        var txtQty = $("#txtQty");
        var txtWarrenty = $("#txtWarrenty");
        var txtVAT = $("#txtVAT");
        var txtTAX = $("#txtTAX");
        var txtDiscount = $("#txtDiscount");
        var stockQty = $("#stockQty");

        $(document).ready(function () {

            $('.select2').select2();

            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
            dptSellsDate.prop('readonly', true);
            dptSellsDate.css("background-color", "#fff");
            $('#dptSellsDate').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true,
                autoclose: true
            });
            var date = new Date();
            var thisDate = date.getDate() + ' ' + getMonthName(date.getMonth() + 1, "MM") + " " + date.getFullYear();
            $('#dptSellsDate').val(thisDate)
            $('#dptSellsDate').trigger('change');
        })

        ddlMobileParts.change(function () {
            $("#stockQty").text('');
            if (ddlMobileParts.val() != "") {
                $.when(postReqWithToken(dataType.applicationJson, dataType.json, 'POST', '/Common2/GetStockForAccessoriesSells', JSON.stringify({ partsId: ddlMobileParts.val()}), getToken())).then(function (res, status) {
                    console.log(res);
                    console.log(status);
                    if (status == "success") {
                        $("#stockQty").text('(' + res + ')');
                    }
                }).fail(function (error) {
                    consoleLog(error);
                })
            }

        })

        //casced dropdown load for CostPrice
        ddlMobileParts.change(function () {
            clearDropdown("ddlsellsPrice");
            if (ddlMobileParts.val() != "") {
                LoadDropDown('/Common2/GetSellPriceForDDL', 'POST', ddlsellsPrice, JSON.stringify({ partsId: ddlMobileParts.val() }));
            }
        })

        function validateInput() {
            $('.error').addClass('hide');
            var isValid = true;
            var count = $("#tblAccessorieSells tbody tr").length;
            if (count > 0) {
                $.each($("#tblAccessorieSells tbody tr"), function (index, item) {
                    var partsId = $(this).children('td').eq(1).html();
                    if (partsId == ddlMobileParts.val()) {
                        isValid = false;
                        $(".duplicate-parts").removeClass('hide');
                    }
                })
            }
            if ($.trim(txtCustomer.val()) == "") {
                $(".require-customer").removeClass("hide");
                isValid = false;
            }
            if ($.trim(txtMobileNumber.val()) == "") {
                $(".require-mobile").removeClass("hide");
                isValid = false;
            }
            if (TryParseInt(txtMobileNumber.val(), 0) <= 0) {
                isValid = false;
                $(".require-mobile").removeClass("hide");
            }
            if (TryParseInt(ddlMobileParts.val(), 0) <= 0) {
                isValid = false;
                $(".require-mobileParts").removeClass("hide");
            }
            if (TryParseInt(ddlsellsPrice.val(), 0) <= 0) {
                isValid = false;
                $(".require-sellPrice").removeClass("hide");
            }
            if (txtQty.val() == "" || TryParseInt(txtQty.val(), 0) <= 0) {
                isValid = false;
                $(".required-qty").removeClass("hide");
            }
            return isValid;
        }

        $("#btnAddToList").click(function (e) {
            e.preventDefault();
            if (validateInput() == true) {
                disable("#txtCustomer");
                disable("#txtMobileNumber");
                disable("#txtEmail");
                disable("#txtAddress");
                var sl = $("#tblAccessorieSells tbody tr").length;
                var td1 = "<td class='text-center text-bold'>" + (sl + 1) + "</td>"
                var td2 = "<td class='hide'>" + ddlMobileParts.val() + "</td>";
                var td3 = "<td>" + $("#ddlMobileParts option:selected").text() + "</td>";
                var td4 = "<td class='text-center'>" + ddlsellsPrice.val() + "</td>";
                var td5 = "<td class='text-center'>" + txtQty.val() + "</td>";
                var td6 = "<td class='text-center'><a href='#' class='btn btn-sm btn-danger data-onfly-del'><i class='far fa-trash-alt'></i> </a></td>";

                var tr = "<tr>" + td1 + td2 + td3 + td4 + td5 + td6 + "</tr>";
                if ($("#tblAccessorieSells tbody tr").length == 0) {
                    $("#tblAccessorieSells tbody").append(tr);
                }
                else {
                    $("#tblAccessorieSells tbody tr").eq(0).before(tr);  
                }
                clearCtrl();
            }
        });
        function clearCtrl() {
            ddlMobileParts.val('');
            ddlsellsPrice.val('');
            txtQty.val('');
            stockQty.val('');
        }
        $(document).on("click", "a.data-onfly-del", function (e) {
            e.preventDefault();
            var index = $(this).parent().parents('tbody tr').index();
            if (bootbox.confirm("Are you sure you want to delete?", function (result) {
                if (result === true) {
                    removeTableRow("#tblAccessorieSells tbody", index);
                    fnFixTheTbodyRowSerialInDecsOrder("#tblAccessorieSells", index);
                };
            }));
        })

         $("#btnInvoiceSubmit").click(function (e) {
            e.preventDefault();
            $(".error").addClass("hide");
                bootbox.confirm("Are you sure you want to save?", function (result) {
                    if (result) {
                        var info = {

                            CustomerName: txtCustomer.val(),
                            CustomerPhone: txtMobileNumber.val(),
                            Email: txtEmail.val(),
                            Address: txtAddress.val(),
                            WarrentyFor: TryParseInt( txtWarrenty.val(),0),
                            VAT: TryParseFloat(txtVAT.val(), 0.00),
                            Tax: TryParseFloat(txtTAX.val(), 0.00),
                            Discount: TryParseFloat(txtDiscount.val(), 0.00),
                        };

                        var details = []; details.length = 0;
                        if ($("#tblAccessorieSells tbody").length > 0) {
                            $.each($("#tblAccessorieSells tbody tr"), function (index, item) {
                                var tds = $(this).children('td');
                                var partsId = tds.eq('1').html();
                                var pName = tds.eq('2').html();
                                var price = tds.eq('3').html();
                                var qty = tds.eq('4').html();

                                details.push({
                                    InvoiceDetailId: 0,
                                    PartsId: TryParseInt(partsId, 0),
                                    PartsName: pName,
                                    Quantity: TryParseInt(qty, 0),
                                    SellPrice: TryParseFloat(price, 0),
                                    Total: (price * qty),
                                })
                            });
                            
                        }
                        
                        var data = JSON.stringify({ info: info, details: details});
                        console.log("Invoice");
                        console.log(data);
                     // return console.log(data);
                        $.when(postReqWithToken(dataType.applicationJson, dataType.json, 'POST', '/FrontDesk/SaveInvoiceForAccessoriesSells', data, getToken())).then(function (res, status) {
                            console.log(res);
                            console.log(status);
                           // enable("#btnSubmit");
                            if (res == true) {
                                $('.toastrDefaultSuccess').trigger('click');
                                setTimeout(function () {
                            redirectPage('@Url.Action("GetJobOrders",new { tab = "AccessoriesSells" })');
                        }, 1000);
                            }
                            else {
                                $('.toastrDefaultError').trigger('click');
                            }
                        }).fail(function (error) {
                            consoleLog(error)
                        })
                    }
                });
        });
        function redirectPage(page) {
            window.location.replace(page);
        }

    </script>
    }