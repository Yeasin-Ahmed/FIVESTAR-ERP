
@{
    ViewBag.Title = "Missing Stock";
}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow card-primary card-outline card-tabs" style="margin-top:-20px">
            <div class="card-header p-0 pt-1 border-bottom-0 text-sm">
                <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="custom-tabs-two-createMissingStock-tab" data-toggle="pill" href="#custom-tabs-two-createMissingStock" role="tab" aria-controls="custom-tabs-two-createMissingStock" aria-selected="true">Missing Stock</a>
                    </li>
                </ul>
            </div>
            <div class="card-body shadow">
                <div class="tab-content" id="custom-tabs-two-tabContent">
                    @Html.AntiForgeryToken()
                    <div class="tab-pane fade show active" id="custom-tabs-two-createMissingStock" role="tabpanel" aria-labelledby="custom-tabs-two-createMissingStock-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray shadow">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Missing Stock List
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="#" style="background-color:darkblue" class="btn btn-outline-primary btn-sm float-lg-right" id="btnAddNew"><i class="fa fa-plus"></i> Create Stock</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-15px">
                                <div class="card shadow card-navy">
                                    <div class="card-header text-sm">
                                        <div class="row text-sm">
                                            <div class=" row col-md-4 card-title">
                                                <h5>Search By</h5>
                                            </div>
                                            <div class="row col-md-8">
                                                <div class="col-md-3">
                                                    @*<label for="ddlModelsSearch" class="control-label font-weight-bold">Model</label>*@
                                                    @Html.DropDownList("ddlModelsSearch", (IEnumerable<SelectListItem>)ViewBag.ddlModels, "--Select Model--", new { @class = "form-control form-control-sm select2" })
                                                </div>
                                                <div class="col-md-3">
                                                    @*<label for="ddlColorsSearch" class="control-label font-weight-bold">Color</label>*@
                                                    @Html.DropDownList("ddlColorsSearch", (IEnumerable<SelectListItem>)ViewBag.ddlColors, "--Select Color--", new { @class = "form-control form-control-sm select2" })
                                                </div>
                                                <div class="col-md-3">
                                                    @*<label for="ddlMobilePartsSearch" class="control-label font-weight-bold">Parts</label>*@
                                                    @Html.DropDownList("ddlMobilePartsSearch", (IEnumerable<SelectListItem>)ViewBag.ddlMobilePart, "--Select Parts--", new { @class = "form-control form-control-sm select2" })
                                                </div>
                                                <div class="col-md-3">
                                                    @*<label for="ddlStockTypeSearch" class="control-label font-weight-bold">Stock Type</label>*@
                                                    <select class="form-control form-control-sm select2" id="ddlStockTypeSearch">
                                                        <option value="">--Select Type--</option>
                                                        <option value="Good">Good</option>
                                                        <option value="DOA">DOA</option>
                                                        <option value="Parts">Parts</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12 text-sm" id="dataContainer">
                                                @{Html.RenderAction("CreateMissingStock", new { @flag = "StockList" });}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMissingStock" role="dialog" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header alert-secondary">
                <h4 id="modalHeading" class="modal-title"><span id="spanModalHeadMissingStock">Add New</span></h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="frmHandsetStock">
                    <input type="hidden" name="Id" id="hdfMissingStockId" />
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="ddlModelsEdit" class="control-label font-weight-bold">Model</label>
                            @Html.DropDownList("ddlModelsEdit", (IEnumerable<SelectListItem>)ViewBag.ddlModels, "--Select Model--", new { @class = "form-control form-control-sm select2" })
                            <span class="error hide req-model">Input Model!</span>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="ddlColorsEdit" class="control-label font-weight-bold">Color</label>
                            @Html.DropDownList("ddlColorsEdit", (IEnumerable<SelectListItem>)ViewBag.ddlColors, "--Select Color--", new { @class = "form-control form-control-sm select2" })
                            <span class="error hide req-color">Input Color!</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="ddlStockTypeEdit" class="control-label font-weight-bold">Stock Type</label>
                            <select class="form-control form-control-sm select2" id="ddlStockTypeEdit">
                                <option value="">--Select Type--</option>
                                <option value="Good">Good</option>
                                <option value="Faulty">Faulty</option>
                                <option value="DOA">DOA</option>
                            </select>
                            <span class="error hide req-stockType">Input Stock Type!</span>
                        </div>
                        <div class="form-group col-md-6" id="divParts">
                            <label for="ddlMobilePartsEdit" class="control-label font-weight-bold">Mobile Parts</label>
                            @Html.DropDownList("ddlMobilePartsEdit", (IEnumerable<SelectListItem>)ViewBag.ddlMobilePart, "--Select Parts--", new { @class = "form-control form-control-sm select2" })
                            <span class="error hide req-parts">Input Parts!</span>
                        </div>
                        <div class="form-group col-md-6" id="divIMEI">
                            <label for="txtIMEIEdit" class="control-label font-weight-bold">IMEI</label>
                            <input type="text" id="txtIMEIEdit" class="form-control form-control-sm" />
                            <span class="error hide req-imei">Input IMEI!</span>
                            <span class="error hide req-imei-range">Input 15 Digits IMEI!</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label for="txtQuantityEdit" class="control-label font-weight-bold">Missing Qty</label>
                            <input type="number" id="txtQuantityEdit" class="form-control form-control-sm" />
                            <span class="error hide req-qty">Input Qty!</span>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer btn-default">
                <button type="button" class="btn btn-outline-danger btn-sm float-right" data-dismiss="modal" data-target="#"><i class="fas fa-paper-plane"></i> Cancel </button>
                <button type="submit" class="btn btn-outline-success btn-sm float-right" id="btnSubmititemType"><i class="fas fa-paper-plane"></i> <span id="spanSaveMissingStock">Save</span> </button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        // Missing Stock List
        var ddlModelsSearch = $("#ddlModelsSearch");
        var ddlColorsSearch = $("#ddlColorsSearch");
        var ddlStockTypeSearch = $("#ddlStockTypeSearch");
        var ddlMobilePartsSearch = $("#ddlMobilePartsSearch");
        var pageNo = 1;

        //Missing Stock Entry
        var ddlMobilePartsEdit = $("#ddlMobilePartsEdit");
        var ddlModelsEdit = $("#ddlModelsEdit");
        var ddlColorsEdit = $("#ddlColorsEdit");
        var ddlStockTypeEdit = $("#ddlStockTypeEdit");
        var txtQuantityEdit = $("#txtQuantityEdit");
        var hdfMissingStockId = $("#hdfMissingStockId");
        var txtIMEIEdit = $("#txtIMEIEdit");

        $(document).ready(function () {
            $('.select2').select2();
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
            //disable("#ddlMobilePartsEdit");
            //disable("#txtIMEIEdit");
            $("#divParts").hide();
            $("#divIMEI").hide();
        })
        //Stock List

        ddlStockTypeEdit.change(function () {
            if (ddlStockTypeEdit.val() === "") {
                //disable("#ddlMobilePartsEdit");
                //disable("#txtIMEIEdit");
                $("#divParts").hide();
                $("#divIMEI").hide();
                ddlMobilePartsEdit.val('');
                ddlMobilePartsEdit.trigger("change");
                txtIMEIEdit.val('');
            }
            else if (ddlStockTypeEdit.val() === "DOA") {
                //disable("#ddlMobilePartsEdit");
                //enable("#txtIMEIEdit");
                $("#divParts").hide();
                $("#divIMEI").show();
                ddlMobilePartsEdit.val('');
                ddlMobilePartsEdit.trigger("change");
            }
            else {
                //enable("#ddlMobilePartsEdit");
                //disable("#txtIMEIEdit");
                $("#divParts").show();
                $("#divIMEI").hide();
                txtIMEIEdit.val('');
            }
        })
        
        ddlModelsSearch.change(function () {
            LoadDataTable();
        })
        ddlColorsSearch.change(function () {
            LoadDataTable();
        })
        ddlStockTypeSearch.change(function () {
            LoadDataTable();
        })

        ddlMobilePartsSearch.change(function () {
            LoadDataTable();
        })
        function LoadDataTable() {
            var data = { flag: "StockList", modelId: TryParseInt(ddlModelsSearch.val(), 0), colorId: TryParseInt(ddlColorsSearch.val(), 0), stockType: ddlStockTypeSearch.val(), partsId: TryParseInt(ddlMobilePartsSearch.val(), 0), page: pageNo };
            $.when(getReqWithData('html', 'GET', '/Configuration/CreateMissingStock', data)).then(function (res, status) {
                if (status === "success") {
                    $("#dataContainer").fadeOut('500', function () {
                        $("#dataContainer").empty();
                        $("#dataContainer").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            })
            pageNo = 1;
        }

        $(document).on('click', 'a.page-link', function (e) {
            e.preventDefault();
            if (!$(this).hasClass('current-page')) {
                if ($(this).parent().parents('div').hasClass('missingStock')) {
                    pageNo = $(this).attr('data-page-no');
                    LoadDataTable();
                }
            }
        })

        // Missing Stock Entry
        function OpenModal() {
            $("#modalMissingStock").modal("show");
            $("#spanModalHeadMissingStock").text('Add New');
            $("#spanSaveMissingStock").text('Save');
            $(".error").addClass("hide");
        }
        $("#btnAddNew").click(function (e) {
            e.preventDefault();
            OpenModal();
            clearCtrl();
        })
        function clearCtrl() {
            hdfMissingStockId.val('0');
            ddlColorsEdit.val('');
            ddlColorsEdit.trigger("change");
            ddlModelsEdit.val('');
            ddlModelsEdit.trigger("change");
            ddlStockTypeEdit.val('');
            ddlStockTypeEdit.trigger("change");
            ddlMobilePartsEdit.val('');
            ddlMobilePartsEdit.trigger("change");
            txtQuantityEdit.val('0');
        }
        $(document).on('click', 'a.data-edit-item', function (e) {
            e.preventDefault();

            OpenModal();
            $("#spanModalHeadMissingStock").text('Update Stock');
            $("#spanSaveMissingStock").text('Update');

            var tds = $(this).parent().parents('tr').children('td');

            hdfMissingStockId.val(tds.eq(1).html());
            ddlModelsEdit.val(tds.eq(5).attr("data-val"));
            ddlModelsEdit.trigger("change");
            ddlColorsEdit.val(tds.eq(6).attr("data-val"));
            ddlColorsEdit.trigger("change");
            ddlMobilePartsEdit.val(tds.eq(7).attr("data-val"));
            ddlMobilePartsEdit.trigger("change");
            ddlStockTypeEdit.val(tds.eq(9).html());
            ddlStockTypeEdit.trigger("change");
            txtQuantityEdit.val(tds.eq(10).html());
            txtIMEIEdit.val(tds.eq(8).html());
        })

        function validateForm() {
            $('.error').addClass('hide');
            var isValid = true;
            if (TryParseInt(ddlModelsEdit.val(), 0) <= 0) {
                isValid = false;
                $(".req-model").removeClass("hide");
            }
            if (TryParseInt(ddlColorsEdit.val(), 0) <= 0) {
                isValid = false;
                $(".req-color").removeClass("hide");
            }
            if (ddlStockTypeEdit.val() == "") {
                isValid = false;
                $(".req-stockType").removeClass("hide");
            }
            else if (ddlStockTypeEdit.val() == "Good" || ddlStockTypeEdit.val() == "Faulty") {
                if (TryParseInt(ddlMobilePartsEdit.val(), 0) <= 0) {
                    isValid = false;
                    $(".req-parts").removeClass("hide");
                }
            }
            else if (ddlStockTypeEdit.val() == "DOA") {
                if ($.trim(txtIMEIEdit.val()) == "") {
                    isValid = false;
                    $(".req-imei").removeClass("hide");
                }
                else if ($.trim(txtIMEIEdit.val()).length != 15) {
                    isValid = false;
                    $(".req-imei-range").removeClass("hide");
                }
            }
            if (TryParseInt(txtQuantityEdit.val(), 0) <= 0) {
                isValid = false;
                $(".req-qty").removeClass("hide");
            }
            //if (TryParseInt(ddlMobilePartsEdit.val(), 0) <= 0) {
            //    isValid = false;
            //    $(".req-parts").removeClass("hide");
            //}
            
            //if ($.trim(txtIMEIEdit.val()) == "") {
            //    isValid = false;
            //    $(".req-imei").removeClass("hide");
            //}
            //else if ($.trim(txtIMEIEdit.val()).length != 15) {
            //    isValid = false;
            //    $(".req-imei-range").removeClass("hide");
            //}
            return isValid;
        }
        $("#spanSaveMissingStock").click(function (e) {
            e.preventDefault();
            if (validateForm() == true) {
                $('.error').addClass('hide');
                var data = JSON.stringify({ MissingStockId: TryParseInt(hdfMissingStockId.val(), 0), DescriptionId: TryParseInt(ddlModelsEdit.val(), 0), ColorId: TryParseInt(ddlColorsEdit.val(), 0), Quantity: TryParseInt(txtQuantityEdit.val(), 0), StockType: ddlStockTypeEdit.val(), PartsId: TryParseInt(ddlMobilePartsEdit.val(), 0), IMEI: $.trim(txtIMEIEdit.val()) });
                $.when(postReqWithToken(dataType.applicationJson, dataType.json, type.post, '/Configuration/SaveMissingStock', data, getToken())).then(function (res, status) {
                    if (status === "success" && res === true) {
                        $("#modalMissingStock").modal('toggle');
                        toastrSuccessAlert(execuStatus.successSave);
                        LoadDataTable();
                        clearCtrl();
                    }
                    else {
                        toastrErrorAlert(execuStatus.fail);
                    }
                })

            }
        })
    </script>
}

